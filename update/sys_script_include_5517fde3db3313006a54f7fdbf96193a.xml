<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_53373_royalapi.royaleAPIClanExtract</api_name>
        <client_callable>false</client_callable>
        <description/>
        <name>royaleAPIClanExtract</name>
        <script><![CDATA[var royaleAPIClanExtract = Class.create();
royaleAPIClanExtract.prototype = {
	initialize: function() {
	},
	
	get: function(){
		gs.info("SI:royaleAPIClanExtract: start");
		try {
			var r = new sn_ws.RESTMessageV2('x_53373_royalapi.RoyalAPI', 'Default GET');
			
			
			var gdt = new GlideDateTime();
			var dayOfWeek = gdt.getDayOfWeekUTC() - 1;
			gdt.addSeconds( -dayOfWeek * 86400);
			
			var weekBeginning = new GlideDateTime();
			weekBeginning.setValue(gdt.getValue().split(' ')[0] +  " 00:00:00");
			
			//gs.info('DisplayValue = ' + weekBeginning.getDisplayValue());
			// gs.info('INternal Value = ' + weekBeginning.getValue() );
			
			var response = r.execute();
			var responseBody = response.getBody();
			var httpStatus = response.getStatusCode();
			gs.debug('httpStatus = ' + httpStatus);
			if ( httpStatus == '200'){
				
				var responseJSON = JSON.parse(responseBody);
				var members = responseJSON.members;
				for ( var i = 0 ; i < members.length ; i++ ) {
					var memberGR = new GlideRecord('x_53373_royalapi_clan_members');
					gs.debug('searching for ' + members[i].tag.toString());
					memberGR.addQuery('tag',members[i].tag.toString());
					memberGR.addQuery('week_beginning',weekBeginning);
					memberGR.query();
					var memberSysId = '';
					if ( memberGR.next()){
						memberSysId = memberGR.sys_id;
					} else {
						// Create the new record
						var newMemberGR = new GlideRecord('x_53373_royalapi_clan_members');
						newMemberGR.name = members[i].name;
						newMemberGR.tag = members[i].tag.toString();
						memberSysId = newMemberGR.insert();
					}
					//gs.debug('sys_id = ' + memberSysId);
					var memberGR2 = new GlideRecord('x_53373_royalapi_clan_members');
					memberGR2.get(memberSysId);
					memberGR2.name = members[i].name;
					//gs.debug('sys_id = ' + memberSysId + );
					if ( members[i].donations > 0 || members[i].donationsReceived > 0){
						memberGR2.donations = members[i].donations;
						memberGR2.donations_received = members[i].donationsReceived;
					}
					memberGR2.week_beginning = weekBeginning;
					memberGR2.update();
				}
				
				
			}
		}
		catch(ex) {
			gs.debug(ex.message);
		}
		
	},
	
	getClanWarLog: function(){
		try {
			var r = new sn_ws.RESTMessageV2('x_53373_royalapi.RoyalAPI', 'Warlog GET');
			var response = r.execute();
			var responseBody = response.getBody();
			var httpStatus = response.getStatusCode();
			gs.debug(httpStatus);
			var clanWarLogArray = JSON.parse(responseBody);
			gs.debug('number of clan wars = ' + clanWarLogArray.length);
			for ( var i = 0 ; i < clanWarLogArray.length ; i++ ){
				//gs.debug(i + ":" + clanWarLogArray[i]);
				var thisJson = clanWarLogArray[i];
				//gs.debug('created date = ' + thisJson.createdDate);
				var thisParticipants = thisJson.participants;
				
				// convert createdDate
				var clanWarDate = new GlideDateTime();
				clanWarDate.setValue("1970-01-01 00:00:00");
				clanWarDate.addSeconds(thisJson.createdDate);
				
				for ( var j = 0 ; j < thisParticipants.length ; j++) {
					var partipantsJson = thisParticipants[j];
					var clanWarLogGr = new GlideRecord('x_53373_royalapi_clan_war_result');
					clanWarLogGr.addQuery('created_date', thisJson.createdDate);
					// clan_war_date
					clanWarLogGr.addEncodedQuery('tag=' + partipantsJson.tag);
					clanWarLogGr.query();
					
					if ( clanWarLogGr.next()){
						clanWarLogGr.name = partipantsJson.name;
						clanWarLogGr.cards_earned = partipantsJson.cardsEarned;
						clanWarLogGr.battles_played = partipantsJson.battlesPlayed;
						clanWarLogGr.wins = partipantsJson.wins;
						clanWarLogGr.clan_war_date = clanWarDate ;
						clanWarLogGr.update();
					} else {
						// create the record
						clanWarLogGr.created_date = thisJson.createdDate;
						clanWarLogGr.tag = partipantsJson.tag;
						clanWarLogGr.name = partipantsJson.name;
						clanWarLogGr.cards_earned = partipantsJson.cardsEarned;
						clanWarLogGr.battles_played = partipantsJson.battlesPlayed;
						clanWarLogGr.wins = partipantsJson.wins;
						clanWarLogGr.clan_war_date = clanWarDate ;
						clanWarLogGr.insert();
					}
				}
				// Get clan standings
				var thisStandings = thisJson.standings;
				for ( var k = 0 ; k < thisStandings.length ; k++){
					var competingClan = thisStandings[k];
					if ( competingClan.tag == 'V2GCC8Y'){
						//gs.debug(clanWarDate.getDisplayValue() + 'V2GCC8Y came ' + (k+1) + "/5" + "new trophy count = " + thisStandings[k].warTrophies + " = change of " + thisStandings[k].warTrophiesChange);
						// Add the record to the [x_53373_royalapi_clan_war_trophies] table
						// V2GCC8Y
						var clanWarTrophies = new GlideRecord('x_53373_royalapi_clan_war_trophies');
						clanWarTrophies.addQuery('clan_war_date',clanWarDate);
						clanWarTrophies.addQuery('clan_tag','V2GCC8Y');
						clanWarTrophies.query();
						if ( ! clanWarTrophies.next() ){
							var addClanWarTrophiesGr = new GlideRecord('x_53373_royalapi_clan_war_trophies');
							addClanWarTrophiesGr.clan_war_date = clanWarDate;
							addClanWarTrophiesGr.clan_tag = 'V2GCC8Y';
							addClanWarTrophiesGr.position = (k+1);
							addClanWarTrophiesGr.trophies = thisStandings[k].warTrophies;
							addClanWarTrophiesGr.trophy_change = thisStandings[k].warTrophiesChange;
							addClanWarTrophiesGr.insert();
						}
						break;
					}
				}
			}
		}
		catch(ex) {
			var message = ex.message();
		}
	},
	
	type: 'royaleAPIClanExtract'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>chikwong.cheung</sys_created_by>
        <sys_created_on>2018-08-14 14:00:10</sys_created_on>
        <sys_customer_update>true</sys_customer_update>
        <sys_id>5517fde3db3313006a54f7fdbf96193a</sys_id>
        <sys_mod_count>76</sys_mod_count>
        <sys_name>royaleAPIClanExtract</sys_name>
        <sys_package display_value="RoyalAPI" source="x_53373_royalapi">6cb47d63db3313006a54f7fdbf9619c5</sys_package>
        <sys_policy>read</sys_policy>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="RoyalAPI">6cb47d63db3313006a54f7fdbf9619c5</sys_scope>
        <sys_update_name>sys_script_include_5517fde3db3313006a54f7fdbf96193a</sys_update_name>
        <sys_updated_by>chikwong.cheung</sys_updated_by>
        <sys_updated_on>2018-09-10 18:31:50</sys_updated_on>
    </sys_script_include>
</record_update>
